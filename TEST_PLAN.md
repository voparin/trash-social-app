# TEST PLAN
Generated by QA Test Manager — 2026-02-18
Covers Done tasks: S1, S2, S2.1, S3, S3.1

> **Prerequisite:** QA-0 must be resolved (Jest + @testing-library/react-native
> installed and configured) before any TC below can be automated. Until then the
> engineer writes manual checklists in `__tests__/manual/`.

---

## RoleContext (S2) — QA-1

### Happy path
- TC-001: Given AsyncStorage returns `'reporter'` for `@trash_social_role`, when `RoleProvider` mounts, then `role` becomes `'reporter'` and `isLoading` becomes `false`.
- TC-002: Given AsyncStorage returns `'collector'`, when `RoleProvider` mounts, then `role` becomes `'collector'`.
- TC-003: Given `saveRole('reporter')` is called, then `AsyncStorage.setItem('@trash_social_role', 'reporter')` is called and `role` state becomes `'reporter'`.
- TC-004: Given `clearRole()` is called, then `AsyncStorage.removeItem('@trash_social_role')` is called and `role` state becomes `null`.

### Edge cases
- TC-005: Given AsyncStorage returns `null` (no saved role), when `RoleProvider` mounts, then `role` stays `null` and `isLoading` becomes `false`.
- TC-006: Given `AsyncStorage.getItem` throws, when `RoleProvider` mounts, then `isLoading` still becomes `false` (finally block fires) and `role` stays `null`.
- TC-007: Given `useRole()` is called outside a `RoleProvider`, then it throws `'useRole must be used within a RoleProvider'`.

---

## RoleSelectScreen + navigation (S1, S2) — QA-2

### Happy path
- TC-008: Given RoleSelectScreen renders, then both "Reporter" and "Collector" buttons are visible and the "Select Your Role" title is shown.
- TC-009: Given user taps "Reporter", then `saveRole('reporter')` is called and navigation goes to `ReporterHome`.
- TC-010: Given user taps "Collector", then `saveRole('collector')` is called and navigation goes to `CollectorHome`.

### Navigation
- TC-011: Given `role` is `'reporter'` in RoleContext on app mount, then `AppNavigator` sets `initialRouteName` to `'ReporterHome'`.
- TC-012: Given `role` is `'collector'` in RoleContext on app mount, then `AppNavigator` sets `initialRouteName` to `'CollectorHome'`.
- TC-013: Given `role` is `null` in RoleContext on app mount, then `AppNavigator` sets `initialRouteName` to `'RoleSelect'`.

---

## Change Role action (S2.1) — QA-3 (manual)

> MapView and CommonActions.reset are hard to test in Jest without significant
> setup; these are manual checklist items.

### Happy path
- TC-014: Given user is on ReporterHome, when they tap "Change Role", then `clearRole()` is called, AsyncStorage has no role, and the screen navigates to RoleSelect.
- TC-015: Given user is on CollectorHome, when they tap "Change Role", then `clearRole()` is called and the screen navigates to RoleSelect.

### Navigation
- TC-016: Given user taps "Change Role" from ReporterHome, then navigation stack is reset to `[RoleSelect]` (no back button visible).
- TC-017: Given user has cleared their role and restarts the app, then app opens on RoleSelect (not Reporter/CollectorHome).

### Regression
- TC-018: Given user selects Reporter → taps Change Role → selects Collector, then Collector home shows correctly (role switch round-trip works).

---

## ReportsContext (S3) — QA-4

### Happy path
- TC-019: Given AsyncStorage returns a JSON array of 2 reports for `@trash_social_reports`, when `ReportsProvider` mounts, then `reports` array has length 2 with correct fields.
- TC-020: Given `addReport(report)` is called with a valid report object, then `AsyncStorage.setItem` is called with the new report prepended to the existing array, and `reports` state is updated.
- TC-021: Given `addReport` is called twice, then `reports` has 2 items with the most recent first (prepend order).

### Edge cases
- TC-022: Given AsyncStorage returns `null` for `@trash_social_reports`, when `ReportsProvider` mounts, then `reports` stays `[]`.
- TC-023: Given `AsyncStorage.getItem` throws on mount, then `reports` stays `[]` (error swallowed).
- TC-024: Given `useReports()` is called outside `ReportsProvider`, then it throws `'useReports must be used within a ReportsProvider'`.

### Persistence — model shape
- TC-025: Given `addReport` is called with a full report object, then the JSON stored in AsyncStorage contains all 7 fields: `id`, `createdAt`, `description`, `photoUri`, `lat`, `lon`, `status`.

---

## CreateReportScreen (S3) — QA-5

### Happy path
- TC-026: Given a description is typed and Submit is tapped, then `addReport` is called with `description` equal to the trimmed input value.
- TC-027: Given a description is entered and Submit is tapped, then `navigation.navigate('ReportSaved', { report })` is called with a report object where `status === 'OPEN'`.
- TC-028: Given photo picker returns an asset with a URI, then the photo preview `<Image>` appears and the button text changes to "Change Photo".
- TC-029: Given location permission is granted and `getCurrentPositionAsync` returns `{latitude: 51.5, longitude: -0.1}`, then the location message shows "GPS: 51.50000, -0.10000".

### Edge cases
- TC-030: Given description is empty when Submit is tapped, then `Alert.alert` is called with title "Missing description" and `navigation.navigate` is NOT called.
- TC-031: Given description contains only whitespace when Submit is tapped, then `Alert.alert` is called (whitespace-only fails `.trim()` check).
- TC-032: Given photo picker returns `canceled: true`, then `photoUri` stays `null` and button text stays "Pick Photo from Library".
- TC-033: Given location permission is denied, then the message "Location permission denied — report will be saved without coordinates." is shown and `coords` stays `null`.
- TC-034: Given location permission is granted but `getCurrentPositionAsync` throws, then the message "Could not get location — report will be saved without coordinates." is shown.
- TC-035: Given Submit is in progress (`submitting === true`), then the Submit button is disabled and shows an `ActivityIndicator` (no double-submit).

### Report model fields
- TC-036: Given a successful submit with no photo and no GPS, then the report passed to `addReport` has `photoUri: null`, `lat: null`, `lon: null`, `status: 'OPEN'`, and `createdAt` is a valid ISO date string.
- TC-037: Given a successful submit, then report `id` is a non-empty string (truthy).

---

## ReporterHomeScreen list (S3) — QA-6

### Happy path
- TC-038: Given `reports` is empty, then the text "No reports yet." is visible and the FlatList is not rendered.
- TC-039: Given `reports` has one item with `description: 'Test trash'`, then the text "Test trash" appears in the list.
- TC-040: Given a report has `lat: 51.5074` and `lon: -0.1278`, then the coords row shows "51.5074, -0.1278" (4 decimal places).
- TC-041: Given a report has `status: 'OPEN'`, then the badge text "OPEN" is visible.
- TC-042: Given tapping "+ New Report", then `navigation.navigate('CreateReport')` is called.

### Edge cases
- TC-043: Given a report has `photoUri: null`, then the "No\nPhoto" placeholder view is rendered (not an `<Image>`).
- TC-044: Given a report has `lat: null` (or `lon: null`), then no coords row is rendered for that item.
- TC-045: Given a report has a very long description, then `numberOfLines={1}` truncates it (ellipsis — visual only, manual verification).

---

## ReportSavedScreen (S3.1) — QA-7

### Happy path
- TC-046: Given `route.params.report` has `lat: 48.8566` and `lon: 2.3522`, then `<MapView>` is rendered with `initialRegion.latitude === 48.8566`.
- TC-047: Given `route.params.report` has `photoUri: 'file://photo.jpg'`, then `<Image source={{ uri: 'file://photo.jpg' }}>` is rendered.
- TC-048: Given the "Back to Home" button is tapped, then `navigation.dispatch` is called with a `CommonActions.reset` action targeting `[{ name: 'ReporterHome' }]`.
- TC-049: Given ReportSavedScreen renders, then the text "Report Saved!" is visible.

### Edge cases
- TC-050: Given `route.params.report` has `photoUri: null`, then "No photo attached" text is visible and no `<Image>` is rendered.
- TC-051: Given `route.params.report` has `lat: null`, then "No location recorded for this report." is visible and no `<MapView>` is rendered.
- TC-052: Given `route.params.report` has `lon: null` (lat is set), then `hasLocation` is `false` — "No location recorded" shown (both must be non-null).
- TC-053: Given `route.params.report` has `lat: 0` and `lon: 0`, then `hasLocation` is `true` (0 != null) and `<MapView>` is rendered.

### Navigation
- TC-054: Given ReportSavedScreen is registered in the stack, then `headerBackVisible: false` means no system back button is shown.
- TC-055: Given user submits two reports back-to-back (each time tapping "Back to Home"), then the navigation stack never exceeds depth 1 at ReporterHome (no stacking of ReportSaved/CreateReport).

---

## Cross-cutting regression — QA-8 (manual)

- TC-056: Given the app is fully fresh (no AsyncStorage), then: RoleSelect shows → select Reporter → ReporterHome shows empty list → create a report → ReportSaved shows → Back to Home → report appears in list.
- TC-057: Given reports exist in AsyncStorage, when app is restarted (killed + reopened), then reports list is repopulated in the same order.
- TC-058: Given the provider nesting in App.js is `RoleProvider → ReportsProvider → AppNavigator`, then both `useRole()` and `useReports()` are available in all screens without throwing.
- TC-059: Given CollectorHomeScreen renders, then the "Change Role" button is present and functions identically to Reporter's (regression: S3 changes did not touch CollectorHomeScreen).
- TC-060: Given all 5 stack screens are registered (RoleSelect, ReporterHome, CollectorHome, CreateReport, ReportSaved), then navigating to each from the correct entry point succeeds without "route not found" errors.
